--Consulta de alumnos

SELECT a.`CARNET`, a.`PRIMER_NOMBRE`,a.`SEGUNDO_NOMBRE`,a.`PRIMER_APELLIDO`,a.`SEGUNDO_APELLIDO`,
a.`DIRECCION`,IF(a.`SEXO` = '2','Masculino','Femenino') As sexo,TIMESTAMPDIFF(YEAR, a.`FECHA`, CURDATE()) As 'EDAD',
g.`DESCRIPCION_GRADO` As grado, 
CONCAT(e.`NOMBRES_ENCARGADO`,' ',e.`APELLIDOS_ENCARGADO`) As encargado,p.`DESCRIPCION_PARENTESCO` As PARENTESCO, d.`NOMBRE_DEPARTAMENTO`,
m.`NOMBRE_MUNICIPIO`
FROM `ALUMNO` a
INNER JOIN `GRADO` g ON g.`CODIGO_GRADO` = a.`GRADO_CODIGO_GRADO`
INNER JOIN `ENCARGADO_ALUMNO` e ON e.`CODIGO_ENCARGADO` = a.`ENCARGADO_ALUMNOS_CODIGO_ENCARGADO`
INNER JOIN `MUNICIPIO` m ON m.`ID_MUNICIPIO` = a.`MUNICIPIO_ID_MUNICIPIO`
INNER JOIN `DEPARTAMENTO` d ON d.`ID_DEPARTAMENTO` = m.`DEPARTAMENTO_ID_DEPARTAMENTO`
INNER JOIN `PARENTESCO` p ON p.`ID_PARENTESCO` = e.`PARENTESCO_IDPARENTESCO`


--CONSULTA DE EMPLEADOS

SELECT e.`CODIGO_EMPLEADO`,e.`NOMBRE_EMPLEADO`,e.`APELLIDO_EMPLEADO`,d.`NOMBRE_DEPARTAMENTO`,
m.`NOMBRE_MUNICIPIO`,IFNULL(u.`NOMBRE_USUARIO`,'') As NOMBRE_USUARIO, 
IFNULL(r.`NOMBRE_ROL`, '') AS ROL,IFNULL(r.`DESCRIPCION_ROL`,'') AS 'DESCRIPCION_ROL'
FROM `EMPLEADO` e 
INNER JOIN `MUNICIPIO` m ON m.`ID_MUNICIPIO` = e.`MUNICIPIO_ID_MUNICIPIO`
LEFT JOIN  `USUARIO` u ON u.`CODIGO_USUARIO` = e.`USUARIO_CODIGO_USUARIO`
LEFT JOIN `ROL` r ON r.`ID_ROL` = u.`ROL_ID_ROL`
INNER JOIN `DEPARTAMENTO` d ON d.`ID_DEPARTAMENTO` = m.`DEPARTAMENTO_ID_DEPARTAMENTO`


--CONSULTA LIBROS

SELECT l.`CODIGO_LIBRO`,l.`TITULO LIBRO`,l.`UBICACION`,l.`CANTIDAD EN EXISTENCIA`, a.`NOMBRE_AUTOR`,
e.`NOMBRE_EDITORIAL`, s.`NOMBRE ASIGNATURA`
FROM `LIBRO` l
INNER JOIN `AUTOR` a ON a.`CODIGO_AUTOR` = l.`AUTOR_CODIGO_AUTOR`
INNER JOIN `EDITORIAL` e ON e.`CODIGO_EDITORIAL` = l.`EDITORIAL_CODIGO_EDITORIAL`
INNER JOIN `ASIGNATURA` s ON s.`CODIGO_ASIGNATURA` = l.`ASIGNATURA_CODIGO_ASIGNATURA`


--PRÃ‰STAMOS
SELECT p.`ID_PRESTAMO`,p.`ALUMNO_CARNET`,p.`FECHA_PRESTAMO`,p.`FECHA_DEVOLUCION`,
IFNULL(p.`FECHA_DEVUELTO`, '') As FECHA_DEVUELTO,
IF(IFNULL(p.`FECHA_DEVUELTO`,'') = '',DATEDIFF(CURDATE(), p.`FECHA_PRESTAMO`),DATEDIFF(p.`FECHA_DEVUELTO`, p.`FECHA_PRESTAMO`)) 
As DIAS_TRANSCURRIDOS,
l.`TITULO LIBRO`,CONCAT(e.`NOMBRE_EMPLEADO`,' ',  e.`APELLIDO_EMPLEADO`) As EMPLEADO
FROM `PRESTAMO` p
INNER JOIN `ALUMNO` a ON a.`CARNET` = p.ALUMNO_CARNET
INNER JOIN `LIBRO` l ON l.`CODIGO_LIBRO` = p.`LIBRO_CODIGO_LIBRO`
INNER JOIN `EMPLEADO` e ON e.`CODIGO_EMPLEADO` = p.`EMPLEADO_CODIGO_EMPLEADO`


--PRÉSTAMOS DEVUELTOS A TIEMPO
SELECT p.`ID_PRESTAMO`,p.`ALUMNO_CARNET`,p.`FECHA_PRESTAMO`,p.`FECHA_DEVOLUCION`,
IFNULL(p.`FECHA_DEVUELTO`, '') As FECHA_DEVUELTO,
IF(IFNULL(p.`FECHA_DEVUELTO`,'') = '',DATEDIFF(CURDATE(), p.`FECHA_PRESTAMO`),DATEDIFF(p.`FECHA_DEVUELTO`, p.`FECHA_PRESTAMO`)) 
As DIAS_TRANSCURRIDOS,
l.`TITULO LIBRO`,CONCAT(e.`NOMBRE_EMPLEADO`,' ',  e.`APELLIDO_EMPLEADO`) As EMPLEADO
FROM `PRESTAMO` p
INNER JOIN `ALUMNO` a ON a.`CARNET` = p.ALUMNO_CARNET
INNER JOIN `LIBRO` l ON l.`CODIGO_LIBRO` = p.`LIBRO_CODIGO_LIBRO`
INNER JOIN `EMPLEADO` e ON e.`CODIGO_EMPLEADO` = p.`EMPLEADO_CODIGO_EMPLEADO`
WHERE p.`FECHA_DEVUELTO` BETWEEN p.`FECHA_PRESTAMO` AND p.`FECHA_DEVOLUCION`



--PRÉSTAMOS NO DEVUELTOS A TIEMPO
SELECT p.`ID_PRESTAMO`,p.`ALUMNO_CARNET`,p.`FECHA_PRESTAMO`,p.`FECHA_DEVOLUCION`,
IFNULL(p.`FECHA_DEVUELTO`, '') As FECHA_DEVUELTO,
IF(IFNULL(p.`FECHA_DEVUELTO`,'') = '',DATEDIFF(CURDATE(), p.`FECHA_PRESTAMO`),DATEDIFF(p.`FECHA_DEVUELTO`, p.`FECHA_PRESTAMO`)) 
As DIAS_TRANSCURRIDOS,
l.`TITULO LIBRO`,CONCAT(e.`NOMBRE_EMPLEADO`,' ',  e.`APELLIDO_EMPLEADO`) As EMPLEADO
FROM `PRESTAMO` p
INNER JOIN `ALUMNO` a ON a.`CARNET` = p.ALUMNO_CARNET
INNER JOIN `LIBRO` l ON l.`CODIGO_LIBRO` = p.`LIBRO_CODIGO_LIBRO`
INNER JOIN `EMPLEADO` e ON e.`CODIGO_EMPLEADO` = p.`EMPLEADO_CODIGO_EMPLEADO`
WHERE p.`FECHA_DEVUELTO` > p.`FECHA_DEVOLUCION`


--PRÉSTAMOS NO DEVUELTOS 
SELECT p.`ID_PRESTAMO`,p.`ALUMNO_CARNET`,p.`FECHA_PRESTAMO`,p.`FECHA_DEVOLUCION`,
IFNULL(p.`FECHA_DEVUELTO`, '') As FECHA_DEVUELTO,
IF(IFNULL(p.`FECHA_DEVUELTO`,'') = '',DATEDIFF(CURDATE(), p.`FECHA_PRESTAMO`),DATEDIFF(p.`FECHA_DEVUELTO`, p.`FECHA_PRESTAMO`)) 
As DIAS_TRANSCURRIDOS,
l.`TITULO LIBRO`,CONCAT(e.`NOMBRE_EMPLEADO`,' ',  e.`APELLIDO_EMPLEADO`) As EMPLEADO
FROM `PRESTAMO` p
INNER JOIN `ALUMNO` a ON a.`CARNET` = p.ALUMNO_CARNET
INNER JOIN `LIBRO` l ON l.`CODIGO_LIBRO` = p.`LIBRO_CODIGO_LIBRO`
INNER JOIN `EMPLEADO` e ON e.`CODIGO_EMPLEADO` = p.`EMPLEADO_CODIGO_EMPLEADO`
WHERE p.`FECHA_DEVUELTO` IS NULL ORDER BY p.`ALUMNO_CARNET` ASC

--ALUMNOS CON MORA
SELECT a.`CARNET`,CONCAT(UPPER(a.`PRIMER_NOMBRE`),' ',UPPER(a.`SEGUNDO_NOMBRE`)) As NOMBRES,
CONCAT(UPPER(a.`PRIMER_APELLIDO`),' ',UPPER(a.`SEGUNDO_APELLIDO`)) As APELLIDOS,
UPPER(g.`DESCRIPCION_GRADO`) AS GRADO,IF(a.`SEXO`='2','Masculino','Femenino') As SEXO,p.`FECHA_PRESTAMO`,
p.`FECHA_DEVOLUCION`,IFNULL(p.`FECHA_DEVUELTO`,'') As FECHA_DEVUELTO,
CONCAT(UPPER(e.`NOMBRE_EMPLEADO`),' ',UPPER((e.`APELLIDO_EMPLEADO`))) AS EMPLEADO
,UPPER(l.`TITULO LIBRO`),UPPER(s.`NOMBRE ASIGNATURA`)
FROM `ALUMNO` a 
INNER JOIN `PRESTAMO` p ON p.`ALUMNO_CARNET` = a.`CARNET`
INNER JOIN `GRADO` g ON g.`CODIGO_GRADO` = a.`GRADO_CODIGO_GRADO`
INNER JOIN `LIBRO` l ON l.`CODIGO_LIBRO` = p.`LIBRO_CODIGO_LIBRO`
INNER JOIN `ASIGNATURA` s ON s.`CODIGO_ASIGNATURA` = l.`ASIGNATURA_CODIGO_ASIGNATURA`
INNER JOIN `EMPLEADO` e ON e.`CODIGO_EMPLEADO` = p.`EMPLEADO_CODIGO_EMPLEADO`
WHERE p.`FECHA_DEVUELTO` IS NULL OR p.`FECHA_DEVUELTO` > p.`FECHA_DEVOLUCION` ORDER BY a.`CARNET`


